# Story 4.7: Implement Project Expiration

**Epic:** E4 - Project Management  
**Status:** ready-for-dev  
**Priority:** P1  
**Dependencies:** E1-S4  
**Blocks:** None

## Story

As a system,
I want projects to auto-expire after 30 days,
so that stale listings are removed from matching.

## Acceptance Criteria

1. **Given** a project is created
   **When** I check expires_at
   **Then** it is set to 30 days from creation

2. **Given** a project past its expires_at
   **When** the expiration job runs
   **Then** status is changed to 'expired'

3. **Given** an expired project
   **When** the owner clicks "Reactivate"
   **Then** status changes to 'active'
   **And** expires_at is reset to 30 days from now

4. **Given** an expired project
   **When** matching runs
   **Then** it is excluded from match results

## Tasks / Subtasks

- [ ] Task 1: Verify expires_at on creation (AC: #1)
  - [ ] Check POST /api/projects sets expires_at
  - [ ] Default to 30 days if not specified

- [ ] Task 2: Create expiration function (AC: #2)
  - [ ] Use DB function `expire_old_projects()`
  - [ ] Set up Supabase cron job or Vercel cron
  - [ ] Run daily at midnight

- [ ] Task 3: Create reactivation endpoint (AC: #3)
  - [ ] Create POST /api/projects/[id]/reactivate
  - [ ] Call DB function `reactivate_project()`
  - [ ] Reset expires_at to now + 30 days

- [ ] Task 4: Exclude from matching (AC: #4)
  - [ ] Update match queries to filter status = 'active'
  - [ ] Verify expired projects don't appear

## Dev Notes

- DB functions already defined in architecture.md
- Supabase has pg_cron extension for scheduled jobs
- Alternative: Vercel cron for serverless

### Code Structure

```typescript
// POST /api/projects/[id]/reactivate
// Response 200
{
  project: Project; // with new expires_at
}

// DB function (already defined)
// reactivate_project(project_id UUID, new_expires_at TIMESTAMP)
```

### Cron Setup

```sql
-- Supabase pg_cron
SELECT cron.schedule(
  'expire-old-projects',
  '0 0 * * *', -- Daily at midnight
  $$SELECT expire_old_projects()$$
);
```

### References

- [Source: planning-artifacts/architecture.md#Database Schema - expire_old_projects]
- [Source: planning-artifacts/prd.md#FR12 Project Expiration]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
