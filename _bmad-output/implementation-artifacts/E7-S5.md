# Story 7.5: Add Real-time Message Updates

**Epic:** E7 - Messaging  
**Status:** ready-for-dev  
**Priority:** P1  
**Dependencies:** 7.1, E6-S1 (Supabase Realtime)  
**Blocks:** None

## Story

As a user,
I want messages to appear instantly,
so that I have a real-time chat experience.

## Acceptance Criteria

1. **Given** I am viewing a conversation
   **When** the other person sends a message
   **Then** it appears instantly without refresh

2. **Given** I am on the conversation list
   **When** a new message arrives
   **Then** the list updates with new preview and time

3. **Given** real-time subscription
   **When** connection drops
   **Then** it reconnects automatically
   **And** missed messages are fetched

## Tasks / Subtasks

- [ ] Task 1: Enable Realtime on messages table (AC: #1)
  - [ ] Enable Realtime for messages table in Supabase
  - [ ] Configure INSERT broadcast

- [ ] Task 2: Subscribe in conversation detail (AC: #1, #3)
  - [ ] Create useRealtimeMessages hook
  - [ ] Subscribe to messages for current conversation
  - [ ] Append new messages to list
  - [ ] Handle reconnection

- [ ] Task 3: Subscribe in conversation list (AC: #2)
  - [ ] Subscribe to messages for user
  - [ ] Update conversation preview on new message
  - [ ] Update unread count

## Dev Notes

- Supabase Realtime handles reconnection automatically
- RLS ensures users only see their messages
- Consider optimistic updates for sent messages

### Code Structure

```typescript
// src/hooks/useRealtimeMessages.ts
export function useRealtimeMessages(
  matchId: string,
  onNewMessage: (message: Message) => void
): void {
  const supabase = createClientComponentClient();
  
  useEffect(() => {
    const channel = supabase
      .channel(`messages:${matchId}`)
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `match_id=eq.${matchId}`
        },
        (payload) => {
          onNewMessage(payload.new as Message);
        }
      )
      .subscribe();

    return () => {
      channel.unsubscribe();
    };
  }, [matchId, onNewMessage]);
}
```

### References

- [Source: planning-artifacts/architecture.md#Supabase Realtime]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
