# Story 5.2: Implement Project-to-Profile Matching

**Epic:** E5 - Matching Engine  
**Status:** ready-for-dev  
**Priority:** P0  
**Dependencies:** E3-S7, E4-S6 (embeddings stored)  
**Blocks:** 5.3

## Story

As a developer,
I want a function that finds profiles matching a project,
so that project owners can discover relevant collaborators.

## Acceptance Criteria

1. **Given** a project with embedding
   **When** I call matchProjectToProfiles()
   **Then** I get top 10 profiles sorted by similarity score

2. **Given** the match results
   **When** I examine the scores
   **Then** each has a score between 0 and 1 (cosine similarity)

3. **Given** the matching function
   **When** the project owner's profile exists
   **Then** it is excluded from results

4. **Given** the matching function
   **When** profiles have no embedding
   **Then** they are excluded from results

## Tasks / Subtasks

- [ ] Task 1: Create matching service (AC: #1, #2)
  - [ ] Create `src/lib/matching/project-to-profile.ts`
  - [ ] Implement pgvector cosine similarity query
  - [ ] Return sorted results with scores

- [ ] Task 2: Add filters (AC: #3, #4)
  - [ ] Filter out project owner's profile
  - [ ] Filter out profiles without embeddings
  - [ ] Optionally filter by availability

- [ ] Task 3: Create match records (AC: #1)
  - [ ] Insert matches into matches table
  - [ ] Store match_score
  - [ ] Avoid duplicate matches

## Dev Notes

- Inverse of 5.1 - project finds profiles instead
- Same pgvector query, different direction
- Consider running when project is created/updated

### Code Structure

```typescript
// src/lib/matching/project-to-profile.ts
export interface ProfileMatchResult {
  profileId: string;
  profile: Profile;
  score: number; // 0-1
}

export async function matchProjectToProfiles(
  projectId: string,
  limit?: number
): Promise<ProfileMatchResult[]>
```

### SQL Query

```sql
SELECT pr.*, 
       1 - (pr.embedding <=> (SELECT embedding FROM projects WHERE id = $1)) as score
FROM profiles pr
WHERE pr.user_id != (SELECT owner_id FROM projects WHERE id = $1)
  AND pr.embedding IS NOT NULL
ORDER BY score DESC
LIMIT 10;
```

### References

- [Source: planning-artifacts/architecture.md#Matching Algorithm]
- [Source: planning-artifacts/architecture.md#match_projects_to_user]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
