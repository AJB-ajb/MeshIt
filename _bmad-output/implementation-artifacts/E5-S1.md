# Story 5.1: Implement Profile-to-Project Matching

**Epic:** E5 - Matching Engine  
**Status:** ready-for-dev  
**Priority:** P0  
**Dependencies:** E3-S7, E4-S6 (embeddings stored)  
**Blocks:** 5.3

## Story

As a developer,
I want a function that finds projects matching a user's profile,
so that users can discover relevant opportunities.

## Acceptance Criteria

1. **Given** a user profile with embedding
   **When** I call matchProfileToProjects()
   **Then** I get top 10 projects sorted by similarity score

2. **Given** the match results
   **When** I examine the scores
   **Then** each has a score between 0 and 1 (cosine similarity)

3. **Given** the matching function
   **When** projects are expired or closed
   **Then** they are excluded from results

4. **Given** the matching function
   **When** the user owns a project
   **Then** that project is excluded from their matches

## Tasks / Subtasks

- [ ] Task 1: Create matching service (AC: #1, #2)
  - [ ] Create `src/lib/matching/profile-to-project.ts`
  - [ ] Implement pgvector cosine similarity query
  - [ ] Return sorted results with scores

- [ ] Task 2: Add filters (AC: #3, #4)
  - [ ] Filter out expired projects (status != 'active')
  - [ ] Filter out user's own projects
  - [ ] Optionally filter by skills overlap

- [ ] Task 3: Create match records (AC: #1)
  - [ ] Insert matches into matches table
  - [ ] Store match_score
  - [ ] Avoid duplicate matches

## Dev Notes

- pgvector cosine distance: `1 - (embedding <=> other_embedding)` for similarity
- Consider caching results or running on schedule
- Match records enable notifications and history

### Code Structure

```typescript
// src/lib/matching/profile-to-project.ts
export interface MatchResult {
  projectId: string;
  project: Project;
  score: number; // 0-1
}

export async function matchProfileToProjects(
  userId: string,
  limit?: number
): Promise<MatchResult[]>
```

### SQL Query

```sql
SELECT p.*, 
       1 - (p.embedding <=> (SELECT embedding FROM profiles WHERE user_id = $1)) as score
FROM projects p
WHERE p.status = 'active'
  AND p.owner_id != $1
  AND p.embedding IS NOT NULL
ORDER BY score DESC
LIMIT 10;
```

### References

- [Source: planning-artifacts/architecture.md#Matching Algorithm]
- [Source: planning-artifacts/architecture.md#match_users_to_project]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
