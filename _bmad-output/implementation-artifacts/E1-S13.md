# Story 1.13: Implement Global Error Handling

**Epic:** E1 - Foundation  
**Status:** ready-for-dev  
**Priority:** P0  
**Dependencies:** E1-S1 (Next.js Project)  
**Blocks:** All API routes

## Story

As a developer,
I want consistent error handling across all API routes and pages,
so that errors are handled gracefully and users see helpful messages.

## Acceptance Criteria

1. **Given** an API route throws an error
   **When** the error is caught
   **Then** a consistent JSON error response is returned
   **And** appropriate HTTP status code is set (400, 401, 403, 404, 500)

2. **Given** an authentication error
   **When** user is not logged in
   **Then** 401 Unauthorized is returned
   **And** user is redirected to login page (on frontend)

3. **Given** an authorization error
   **When** user lacks permission
   **Then** 403 Forbidden is returned
   **And** helpful message explains the restriction

4. **Given** a validation error
   **When** request body is invalid
   **Then** 400 Bad Request is returned
   **And** validation errors are listed

5. **Given** an unexpected server error
   **When** it occurs in production
   **Then** 500 Internal Server Error is returned
   **And** error is logged to Sentry
   **And** user sees generic error message (no stack trace)

6. **Given** a page component error
   **When** React component throws
   **Then** error boundary catches it
   **And** fallback UI is shown

## Tasks / Subtasks

- [ ] Task 1: Create error types and utilities (AC: #1)
  - [ ] Create `src/lib/errors/types.ts` with custom error classes
  - [ ] Create `src/lib/errors/api-error.ts` for API error responses
  - [ ] Define AppError, ValidationError, AuthError, NotFoundError

- [ ] Task 2: Create API error handler (AC: #1, #4, #5)
  - [ ] Create `src/lib/errors/handler.ts`
  - [ ] Map error types to HTTP status codes
  - [ ] Format consistent JSON response
  - [ ] Log errors appropriately

- [ ] Task 3: Create API middleware wrapper (AC: #1, #2, #3)
  - [ ] Create `src/lib/api/with-error-handling.ts`
  - [ ] Wrap route handlers with try/catch
  - [ ] Check authentication/authorization
  - [ ] Return proper error responses

- [ ] Task 4: Set up Sentry integration (AC: #5)
  - [ ] Install `@sentry/nextjs`
  - [ ] Configure Sentry DSN
  - [ ] Create `sentry.client.config.ts` and `sentry.server.config.ts`
  - [ ] Test error capture

- [ ] Task 5: Create error boundary (AC: #6)
  - [ ] Create `src/components/error-boundary.tsx`
  - [ ] Wrap app layout with error boundary
  - [ ] Create fallback UI component

- [ ] Task 6: Create error pages (AC: #6)
  - [ ] Create `src/app/error.tsx` (runtime errors)
  - [ ] Create `src/app/not-found.tsx` (404)
  - [ ] Create `src/app/global-error.tsx` (root errors)

## Dev Notes

### Error Response Format

```typescript
// Consistent API error response
interface ApiErrorResponse {
  error: {
    code: string;
    message: string;
    details?: Record<string, string[]>; // Validation errors
  };
  status: number;
}
```

### Custom Error Classes

```typescript
// src/lib/errors/types.ts
export class AppError extends Error {
  constructor(
    public code: string,
    public message: string,
    public statusCode: number = 500
  ) {
    super(message);
  }
}

export class ValidationError extends AppError {
  constructor(public details: Record<string, string[]>) {
    super('VALIDATION_ERROR', 'Validation failed', 400);
  }
}

export class AuthenticationError extends AppError {
  constructor(message = 'Not authenticated') {
    super('UNAUTHENTICATED', message, 401);
  }
}

export class AuthorizationError extends AppError {
  constructor(message = 'Not authorized') {
    super('UNAUTHORIZED', message, 403);
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string) {
    super('NOT_FOUND', `${resource} not found`, 404);
  }
}
```

### References

- [Source: planning-artifacts/prd.md#10 Risks]
- [Source: planning-artifacts/architecture.md#Infrastructure]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

