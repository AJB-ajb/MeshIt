# Story 6.7: Implement Match Notification Emails

**Epic:** E6 - Notifications  
**Status:** ready-for-dev  
**Priority:** P1  
**Dependencies:** E6-S5 (Email Notifications), E5-S7 (Apply/Accept Flow)  
**Blocks:** None

## Story

As a user,
I want to receive email notifications when I get new matches,
so that I don't miss opportunities even when not using the app.

## Acceptance Criteria

1. **Given** a new match is created for a project
   **When** the match is saved
   **Then** an email is sent to the matched user
   **And** email contains project title and match score

2. **Given** the email
   **When** user receives it
   **Then** it has a clear subject line ("New match on MeshIt!")
   **And** it has a CTA button to view the match
   **And** it's mobile-responsive HTML

3. **Given** email sending
   **When** it fails
   **Then** error is logged
   **And** in-app notification still works
   **And** no error is shown to user

4. **Given** user preferences (future)
   **When** user has disabled email notifications
   **Then** no email is sent

## Tasks / Subtasks

- [ ] Task 1: Create email template (AC: #2)
  - [ ] Create `src/lib/email/templates/new-match.tsx` (React Email)
  - [ ] Design mobile-responsive HTML
  - [ ] Include project title, match score, CTA button
  - [ ] Include unsubscribe link (placeholder)

- [ ] Task 2: Implement send function (AC: #1, #3)
  - [ ] Create `src/lib/email/send-match-notification.ts`
  - [ ] Use Resend API to send
  - [ ] Handle errors gracefully
  - [ ] Log success/failure

- [ ] Task 3: Trigger on match creation (AC: #1)
  - [ ] Add email trigger to match creation flow
  - [ ] Or use Supabase Database Webhook
  - [ ] Ensure async (don't block API response)

- [ ] Task 4: Test email delivery (AC: #1, #2)
  - [ ] Test with Resend test mode
  - [ ] Verify email renders correctly
  - [ ] Verify links work

## Dev Notes

### Email Template (React Email)

```tsx
// src/lib/email/templates/new-match.tsx
import { Html, Head, Body, Container, Heading, Text, Button } from '@react-email/components';

interface NewMatchEmailProps {
  userName: string;
  projectTitle: string;
  matchScore: number;
  matchUrl: string;
}

export function NewMatchEmail({ userName, projectTitle, matchScore, matchUrl }: NewMatchEmailProps) {
  return (
    <Html>
      <Head />
      <Body style={{ fontFamily: 'sans-serif' }}>
        <Container>
          <Heading>New Match on MeshIt! ðŸŽ‰</Heading>
          <Text>Hi {userName},</Text>
          <Text>
            You matched with "{projectTitle}" with a {Math.round(matchScore * 100)}% compatibility score!
          </Text>
          <Button href={matchUrl} style={{ background: '#000', color: '#fff', padding: '12px 24px' }}>
            View Match
          </Button>
        </Container>
      </Body>
    </Html>
  );
}
```

### Send Function

```typescript
// src/lib/email/send-match-notification.ts
import { Resend } from 'resend';
import { NewMatchEmail } from './templates/new-match';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function sendMatchNotificationEmail(params: {
  to: string;
  userName: string;
  projectTitle: string;
  matchScore: number;
  matchId: string;
}) {
  try {
    await resend.emails.send({
      from: 'MeshIt <notifications@meshit.app>',
      to: params.to,
      subject: `New match: ${params.projectTitle}`,
      react: NewMatchEmail({
        userName: params.userName,
        projectTitle: params.projectTitle,
        matchScore: params.matchScore,
        matchUrl: `${process.env.NEXT_PUBLIC_APP_URL}/matches/${params.matchId}`,
      }),
    });
  } catch (error) {
    console.error('Failed to send match notification email:', error);
    // Don't throw - email failure shouldn't break the flow
  }
}
```

### References

- [Source: planning-artifacts/prd.md#4.6 Notifications]
- [Source: planning-artifacts/architecture.md#n8n Automation]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

