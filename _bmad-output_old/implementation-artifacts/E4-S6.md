# Story 4.6: Store Project Embeddings

**Epic:** E4 - Project Management  
**Status:** ready-for-dev  
**Priority:** P0  
**Dependencies:** 3.2, E1-S4  
**Blocks:** E5 (Matching Engine)

## Story

As a system,
I want project embeddings stored in pgvector,
so that semantic matching can find relevant profiles.

## Acceptance Criteria

1. **Given** a new project is created
   **When** the save completes
   **Then** an embedding is generated and stored in projects.embedding

2. **Given** a project is updated (title/description/skills changed)
   **When** the update completes
   **Then** the embedding is regenerated and updated

3. **Given** the embedding column
   **When** I query with cosine similarity against profiles
   **Then** relevant profiles are returned ranked by score

## Tasks / Subtasks

- [ ] Task 1: Create embedding storage function (AC: #1, #2)
  - [ ] Create `src/lib/ai/project-embedding.ts`
  - [ ] Implement updateProjectEmbedding function
  - [ ] Handle null/empty projects

- [ ] Task 2: Integrate with project save (AC: #1)
  - [ ] Call embedding generation after project create
  - [ ] Store in projects.embedding column

- [ ] Task 3: Integrate with project update (AC: #2)
  - [ ] Detect if embedding-relevant fields changed
  - [ ] Regenerate embedding if needed

- [ ] Task 4: Test cross-table similarity (AC: #3)
  - [ ] Query project embedding against profiles
  - [ ] Verify ranking makes sense

## Dev Notes

- Use same embedding model as profiles (text-embedding-3-small)
- Cross-table matching: project.embedding vs profiles.embedding
- Consider batch embedding for efficiency

### Code Structure

```typescript
// src/lib/ai/project-embedding.ts
export async function updateProjectEmbedding(
  projectId: string,
  project: { title: string; description: string; skills_needed: string[] }
): Promise<void>

// SQL for cross-table similarity
// SELECT p.* FROM profiles p
// WHERE p.embedding IS NOT NULL
// ORDER BY p.embedding <=> (SELECT embedding FROM projects WHERE id = $1)
// LIMIT 10;
```

### References

- [Source: planning-artifacts/architecture.md#Embedding Generation]
- [Source: planning-artifacts/architecture.md#Matching Algorithm]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
