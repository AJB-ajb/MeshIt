# Story 7.1: Create Message API Routes

**Epic:** E7 - Messaging  
**Status:** ready-for-dev  
**Priority:** P1  
**Dependencies:** E1-S4, E1-S10  
**Blocks:** 7.2, 7.3, 7.4

## Story

As a frontend,
I want API endpoints for messaging,
so that users can send and receive messages.

## Acceptance Criteria

1. **Given** a POST request to /api/messages
   **When** user is authenticated and has a match
   **Then** a new message is created

2. **Given** a GET request to /api/conversations
   **When** user is authenticated
   **Then** their conversations are returned

3. **Given** a GET request to /api/conversations/[id]/messages
   **When** user is part of the conversation
   **Then** messages in that conversation are returned

4. **Given** a new message
   **When** it is created
   **Then** a notification is triggered for the recipient

## Tasks / Subtasks

- [ ] Task 1: Create POST /api/messages (AC: #1)
  - [ ] Create `src/app/api/messages/route.ts`
  - [ ] Accept recipient_id, match_id, content
  - [ ] Verify sender is part of match
  - [ ] Create message record

- [ ] Task 2: Create GET /api/conversations (AC: #2)
  - [ ] Create `src/app/api/conversations/route.ts`
  - [ ] Query messages grouped by match/conversation
  - [ ] Return with last message preview

- [ ] Task 3: Create GET /api/conversations/[id]/messages (AC: #3)
  - [ ] Create `src/app/api/conversations/[id]/messages/route.ts`
  - [ ] Verify user is participant
  - [ ] Return messages sorted by date

- [ ] Task 4: Trigger notification (AC: #4)
  - [ ] Call notification service on message create
  - [ ] Send email if enabled

## Dev Notes

- Conversations are derived from matches (match_id groups messages)
- RLS policies ensure users can only see their messages
- Consider pagination for long conversations

### API Specification

```typescript
// POST /api/messages
// Request
{
  match_id: string;
  content: string;
}
// Response 201
{
  message: Message;
}

// GET /api/conversations
// Response 200
{
  conversations: {
    match_id: string;
    other_user: { id: string; name: string; avatar: string };
    last_message: string;
    last_message_at: string;
    unread_count: number;
  }[]
}

// GET /api/conversations/[id]/messages
// Response 200
{
  messages: Message[];
}
```

### References

- [Source: planning-artifacts/architecture.md#API Routes Specification]
- [Source: planning-artifacts/prd.md#FR22-25 Messaging]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
