# Story 3.7: Store Profile Embeddings

**Epic:** E3 - Profile Management  
**Status:** ready-for-dev  
**Priority:** P0  
**Dependencies:** 3.2, E1-S4  
**Blocks:** E5 (Matching Engine)

## Story

As a system,
I want profile embeddings stored in pgvector,
so that semantic matching can be performed.

## Acceptance Criteria

1. **Given** a new profile is created
   **When** the save completes
   **Then** an embedding is generated and stored in profiles.embedding

2. **Given** a profile is updated (skills/interests changed)
   **When** the update completes
   **Then** the embedding is regenerated and updated

3. **Given** the embedding column
   **When** I query with cosine similarity
   **Then** similar profiles are returned ranked by score

## Tasks / Subtasks

- [ ] Task 1: Create embedding storage function (AC: #1, #2)
  - [ ] Create `src/lib/ai/profile-embedding.ts`
  - [ ] Implement updateProfileEmbedding function
  - [ ] Handle null/empty profiles

- [ ] Task 2: Integrate with profile save (AC: #1)
  - [ ] Call embedding generation after profile create
  - [ ] Store in profiles.embedding column

- [ ] Task 3: Integrate with profile update (AC: #2)
  - [ ] Detect if embedding-relevant fields changed
  - [ ] Regenerate embedding if needed

- [ ] Task 4: Test similarity search (AC: #3)
  - [ ] Create test query using pgvector
  - [ ] Verify results are ranked correctly

## Dev Notes

- pgvector cosine distance: `<=>` operator
- Only regenerate embedding if skills/interests/experience change
- Consider background job for embedding generation

### Code Structure

```typescript
// src/lib/ai/profile-embedding.ts
export async function updateProfileEmbedding(
  userId: string,
  profile: StructuredProfile
): Promise<void>

// SQL for similarity search
// SELECT * FROM profiles
// ORDER BY embedding <=> $1
// LIMIT 10;
```

### References

- [Source: planning-artifacts/architecture.md#Embedding Generation]
- [Source: planning-artifacts/architecture.md#pgvector]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
