# Story 5.8: Auto-Expire Old Projects

**Epic:** E5 - Matching Engine  
**Status:** ready-for-dev  
**Priority:** P1  
**Dependencies:** E4-S2 (Project CRUD)  
**Blocks:** None

## Story

As a system,
I want to automatically expire projects past their expiry date,
so that users don't see stale projects in match results.

## Acceptance Criteria

1. **Given** a project with expires_at in the past
   **When** the expiry check runs
   **Then** project status changes to 'expired'

2. **Given** an expired project
   **When** users search for projects
   **Then** it does not appear in results

3. **Given** an expired project
   **When** the creator views their projects
   **Then** they see it marked as "Expired"

4. **Given** the expiry system
   **When** it runs
   **Then** it completes within 5 seconds for 1000 projects (NFR)

5. **Given** a project creator
   **When** their project is about to expire (24h warning)
   **Then** they receive a notification (optional)

## Tasks / Subtasks

- [ ] Task 1: Create expiry check function (AC: #1, #4)
  - [ ] Create Supabase Edge Function or DB function
  - [ ] Query projects WHERE expires_at < now() AND status = 'open'
  - [ ] Update status to 'expired'
  - [ ] Log count of expired projects

- [ ] Task 2: Schedule automatic execution (AC: #1)
  - [ ] Option A: Supabase pg_cron extension
  - [ ] Option B: Vercel Cron Job
  - [ ] Run every hour (or on-demand via API)

- [ ] Task 3: Update queries to exclude expired (AC: #2)
  - [ ] Verify matching queries filter by status = 'open'
  - [ ] Verify project listing excludes expired
  - [ ] Add index on (status, expires_at) if needed

- [ ] Task 4: Update UI for expired projects (AC: #3)
  - [ ] Show "Expired" badge on creator's project list
  - [ ] Disable "Edit" actions on expired projects
  - [ ] Add "Reactivate" option (sets new expires_at)

- [ ] Task 5: (Optional) Expiry warning notification (AC: #5)
  - [ ] Query projects expiring in next 24h
  - [ ] Send notification to creator
  - [ ] Run as part of scheduled job

## Dev Notes

### Option A: Supabase pg_cron

```sql
-- Enable pg_cron extension
create extension if not exists pg_cron;

-- Schedule job to run every hour
select cron.schedule(
  'expire-old-projects',
  '0 * * * *',  -- Every hour
  $$
  UPDATE projects 
  SET status = 'expired', updated_at = now()
  WHERE expires_at < now() AND status = 'open';
  $$
);
```

### Option B: Vercel Cron (vercel.json)

```json
{
  "crons": [
    {
      "path": "/api/cron/expire-projects",
      "schedule": "0 * * * *"
    }
  ]
}
```

### Option C: On-demand with matching

Run expiry check as part of matching queries (less efficient but simpler).

### References

- [Source: planning-artifacts/architecture.md#projects table]
- [Source: planning-artifacts/prd.md#4.2 Project Posting]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

