# Story 6.6: Trigger Match Notifications

**Epic:** E6 - Notifications  
**Status:** ready-for-dev  
**Priority:** P1  
**Dependencies:** 6.2, E5 (Matching Engine)  
**Blocks:** None

## Story

As a system,
I want to send notifications when matches are created,
so that users are informed of new opportunities.

## Acceptance Criteria

1. **Given** a new match is created
   **When** the match score is above threshold (e.g., 70%)
   **Then** an in-app notification is created for the user

2. **Given** a new match notification
   **When** the user has email enabled
   **Then** an email notification is also sent

3. **Given** a project owner
   **When** their project gets new matches
   **Then** they receive notifications for top matches

4. **Given** notification creation
   **When** it fails
   **Then** the match creation still succeeds

## Tasks / Subtasks

- [ ] Task 1: Create match notification trigger (AC: #1, #4)
  - [ ] Create `src/lib/matching/notify.ts`
  - [ ] Implement notifyNewMatch function
  - [ ] Set score threshold (configurable)

- [ ] Task 2: Integrate with match creation (AC: #1, #3)
  - [ ] Call notifyNewMatch after match saved
  - [ ] Notify both profile owner and project owner
  - [ ] Use try/catch to not block on failure

- [ ] Task 3: Add email notification (AC: #2)
  - [ ] Check user's email preferences
  - [ ] Call sendMatchEmail if enabled

## Dev Notes

- Score threshold prevents notification spam
- Consider batching notifications for multiple matches
- DB trigger alternative: create notification on match insert

### Code Structure

```typescript
// src/lib/matching/notify.ts
const MATCH_NOTIFICATION_THRESHOLD = 0.7; // 70%

export async function notifyNewMatch(match: {
  id: string;
  profileUserId: string;
  projectOwnerId: string;
  score: number;
  projectTitle: string;
}): Promise<void>
```

### DB Trigger Alternative

```sql
-- Trigger to create notification on match insert
CREATE OR REPLACE FUNCTION notify_on_match()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.match_score >= 0.7 THEN
    INSERT INTO notifications (user_id, type, title, message, link)
    VALUES (
      NEW.profile_id,
      'new_match',
      'New Match!',
      'You matched with a project',
      '/matches/' || NEW.id
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER match_notification_trigger
AFTER INSERT ON matches
FOR EACH ROW EXECUTE FUNCTION notify_on_match();
```

### References

- [Source: planning-artifacts/architecture.md#Notification Triggers]
- [Source: planning-artifacts/prd.md#FR18 Match Notifications]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
